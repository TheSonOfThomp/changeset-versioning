name: Major Release

# On push to `next`
# - open a "Major Release" PR targeted at `main`

on:
  push:
    branches:
      - next

permissions:
  id-token: write
  contents: write
  pull-requests: write

jobs:
  release:
    name: "Major release"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          fetch-depth: 0

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Fetch all branches
        run: git fetch origin

      - name: Checkout main
        run: git checkout main

      - name: Checkout next
        run: git checkout next

      - name: Attempt to merge main into next
        id: merge
        continue-on-error: true
        run: |
          git merge --no-ff origin/main -m "Merge main into next" || exit 1

      - name: Push merge if successful
        if: steps.merge.outcome == 'success'
        run: git push origin next

      - name: Abort merge if conflicts
        if: steps.merge.outcome == 'failure'
        run: git merge --abort || true

      - name: Create PR if merge conflicts
        if: steps.merge.outcome == 'failure'
        run: |
          gh pr create \
            --base next \
            --head main \
            --title "ðŸ¦‹ Merge main into next" \
            --body "This PR was automatically created because there are merge conflicts when attempting to merge \`main\` into \`next\`. Please resolve the conflicts and merge this PR manually."
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup pnpm
        if: steps.merge.outcome == 'success'
        uses: pnpm/action-setup@v2

      - name: Install dependencies
        if: steps.merge.outcome == 'success'
        run: pnpm install

      - name: Build
        if: steps.merge.outcome == 'success'
        run: pnpm build

      # Create Release Pull Request or Publish
      - name: Create Release Pull Request or Publish
        if: steps.merge.outcome == 'success'
        uses: changesets/action@v1
        with:
          # On every merge to `next`, create a Major Release PR
          title: "ðŸ¦‹ Major Release"
          version: pnpm changeset version
          # When the Major Release PR is merged
          publish: pnpm changeset publish
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NPM_TOKEN: ${{ secrets.NPM_TOKEN }}
